<div class="reference-manager">
  <div class="manager-header">
    <h4>Schema Reference Manager</h4>
    <div class="draft-info">
      <span>Using: {{ isDraft2019Plus() ? '$defs' : 'definitions' }} 
        <small>({{ currentDraft }})</small>
      </span>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button 
      type="button"
      class="tab-btn"
      [class.active]="activeTab === 'definitions'"
      (click)="setActiveTab('definitions')">
      <span>Definitions</span>
      <span class="badge">{{ definitionsList.length }}</span>
    </button>
    
    <button 
      type="button"
      class="tab-btn"
      [class.active]="activeTab === 'references'"
      (click)="setActiveTab('references')">
      <span>References</span>
      <span class="badge">{{ referenceUsages.length }}</span>
    </button>
    
    <button 
      type="button"
      class="tab-btn"
      [class.active]="activeTab === 'browser'"
      (click)="setActiveTab('browser')">
      <span>Browse</span>
    </button>
  </div>

  <!-- Definitions Tab -->
  <div class="tab-content" *ngIf="activeTab === 'definitions'">
    <div class="definitions-section">
      
      <!-- Create New Definition -->
      <div class="create-definition-section">
        <h5>Create New Definition</h5>
        
        <div class="definition-form">
          <div class="form-row">
            <div class="field-group">
              <label>Name:</label>
              <input 
                type="text" 
                [(ngModel)]="newDefinitionName"
                placeholder="Enter definition name"
                (keyup.enter)="createDefinition()">
            </div>
            
            <div class="field-group">
              <label>Type:</label>
              <select [(ngModel)]="newDefinitionType">
                <option [value]="PropertyType.OBJECT">Object</option>
                <option [value]="PropertyType.ARRAY">Array</option>
                <option [value]="PropertyType.STRING">String</option>
                <option [value]="PropertyType.NUMBER">Number</option>
                <option [value]="PropertyType.INTEGER">Integer</option>
                <option [value]="PropertyType.BOOLEAN">Boolean</option>
              </select>
            </div>
            
            <button 
              type="button" 
              class="create-btn"
              (click)="createDefinition()"
              [disabled]="!newDefinitionName.trim()">
              Create
            </button>
          </div>
        </div>

        <!-- Quick Templates -->
        <div class="template-section">
          <label>Quick Templates:</label>
          <div class="template-buttons">
            <button 
              *ngFor="let template of commonSchemaTemplates"
              type="button"
              class="template-btn"
              (click)="createFromTemplate(template)">
              {{ template.name }}
              <small>{{ template.type }}</small>
            </button>
          </div>
        </div>
      </div>

      <!-- Definitions List -->
      <div class="definitions-list">
        <h5>Existing Definitions</h5>
        
        <div class="definitions-grid" *ngIf="definitionsList.length > 0">
          <div 
            class="definition-card" 
            *ngFor="let definition of definitionsList"
            [class.selected]="selectedDefinition === definition.id"
            (click)="selectDefinition(definition.id)">
            
            <div class="definition-header">
              <div class="definition-name">{{ definition.name }}</div>
              <div class="definition-actions">
                <span 
                  class="usage-badge"
                  [class]="getReferenceStatusBadge(definition.usageCount)">
                  {{ definition.usageCount }} use{{ definition.usageCount === 1 ? '' : 's' }}
                </span>
                <button 
                  type="button" 
                  class="delete-btn"
                  (click)="deleteDefinition(definition.id); $event.stopPropagation()"
                  title="Delete Definition">
                  ×
                </button>
              </div>
            </div>
            
            <div class="definition-preview">
              {{ getDefinitionPreview(definition.schema) }}
            </div>
            
            <div class="definition-description" *ngIf="definition.description">
              {{ definition.description }}
            </div>
            
            <div class="definition-controls">
              <button 
                type="button" 
                class="reference-btn"
                (click)="createReference(definition.id); $event.stopPropagation()"
                [disabled]="!currentProperty"
                title="Create Reference to This Definition">
                Create $ref
              </button>
            </div>
          </div>
        </div>

        <div class="empty-state" *ngIf="definitionsList.length === 0">
          <p>No definitions created yet.</p>
          <p>Create reusable schema definitions to build modular, maintainable schemas.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- References Tab -->
  <div class="tab-content" *ngIf="activeTab === 'references'">
    <div class="references-section">
      <h5>Reference Usage Analysis</h5>
      
      <div class="usage-summary">
        <div class="summary-stats">
          <div class="stat-item">
            <span class="stat-value">{{ definitionsList.length }}</span>
            <span class="stat-label">Definitions</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ referenceUsages.length }}</span>
            <span class="stat-label">References</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ getUnusedDefinitionsCount() }}</span>
            <span class="stat-label">Unused</span>
          </div>
        </div>
      </div>

      <!-- Reference Usage Details -->
      <div class="reference-usage-list" *ngIf="referenceUsages.length > 0">
        <div 
          class="usage-item" 
          *ngFor="let usage of referenceUsages">
          
          <div class="usage-path">
            <code>{{ usage.path }}</code>
          </div>
          
          <div class="usage-arrow">→</div>
          
          <div class="usage-target">
            <span class="target-name">{{ usage.targetDefinition }}</span>
            <code class="ref-path">{{ usage.property.$ref }}</code>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="referenceUsages.length === 0">
        <p>No references found in the current schema.</p>
        <p>Use the <strong>Browse</strong> tab to create references to your definitions.</p>
      </div>

      <!-- Unused Definitions Warning -->
      <div class="unused-definitions-warning" *ngIf="getUnusedDefinitionsCount() > 0">
        <h6>Unused Definitions</h6>
        <p>The following definitions are not referenced anywhere:</p>
        <ul>
          <li *ngFor="let def of getUnusedDefinitions()">
            <strong>{{ def.name }}</strong>
            <button 
              type="button" 
              class="cleanup-btn"
              (click)="deleteDefinition(def.id)">
              Remove
            </button>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Browse Tab -->
  <div class="tab-content" *ngIf="activeTab === 'browser'">
    <div class="browser-section">
      <h5>Reference Browser</h5>
      
      <div class="browser-controls">
        <div class="search-box">
          <input 
            type="text" 
            [(ngModel)]="referenceFilter"
            placeholder="Filter available references..."
            class="filter-input">
        </div>
        
        <div class="current-property-info" *ngIf="currentProperty">
          <span>Target: <strong>{{ currentProperty.name }}</strong></span>
          <small>({{ currentProperty.type }})</small>
        </div>
      </div>

      <div class="available-references" *ngIf="getFilteredReferences().length > 0">
        <div 
          class="reference-item"
          *ngFor="let ref of getFilteredReferences()">
          
          <div class="reference-info">
            <code class="reference-path">{{ ref }}</code>
            <div class="reference-definition">
              {{ getDefinitionPreview(definitions[extractDefinitionNameFromRef(ref)]) }}
            </div>
          </div>
          
          <button 
            type="button"
            class="use-reference-btn"
            (click)="createReference(extractDefinitionNameFromRef(ref))"
            [disabled]="!currentProperty">
            Use Reference
          </button>
        </div>
      </div>

      <div class="empty-state" *ngIf="getFilteredReferences().length === 0">
        <p *ngIf="!referenceFilter">No definitions available for referencing.</p>
        <p *ngIf="referenceFilter">No references match your filter "{{ referenceFilter }}".</p>
        <p>Create definitions in the <strong>Definitions</strong> tab first.</p>
      </div>

      <!-- Current Property Reference Info -->
      <div class="current-ref-info" *ngIf="currentProperty?.$ref">
        <h6>Current Reference</h6>
        <div class="current-ref-display">
          <code>{{ currentProperty?.$ref }}</code>
          <button 
            type="button" 
            class="clear-ref-btn"
            (click)="propertyRefUpdate.emit({ property: currentProperty!, ref: '' })">
            Clear Reference
          </button>
        </div>
      </div>

      <!-- No Property Selected -->
      <div class="no-property-selected" *ngIf="!currentProperty">
        <p>Select a property in the main editor to create references.</p>
      </div>
    </div>
  </div>

  <!-- Import/Export Section -->
  <div class="import-export-section">
    <h6>Import/Export Definitions</h6>
    <div class="import-export-controls">
      <button 
        type="button" 
        class="export-btn"
        (click)="exportDefinitions()"
        [disabled]="definitionsList.length === 0">
        Export Definitions
      </button>
      
      <div class="import-controls">
        <input 
          type="file" 
          accept=".json"
          #importFile
          style="display: none"
          (change)="onFileImport($event)">
        <button 
          type="button" 
          class="import-btn"
          (click)="importFile.click()">
          Import Definitions
        </button>
      </div>
    </div>
  </div>
</div>