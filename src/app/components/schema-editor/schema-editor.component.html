<!-- Phase 2 Feature Guide -->
<app-feature-guide></app-feature-guide>

<!-- Neo4j Browser-Style Layout -->
<div class="neo4j-layout">
  <!-- Left Vertical Navigation -->
  <div class="vertical-nav">
    <button 
      class="nav-tab"
      [class.active]="currentView === 'workspace'"
      (click)="setCurrentView('workspace')"
      title="Schema Workspace">
      <div class="nav-icon">ğŸ—„ï¸</div>
      <span class="nav-label">Workspace</span>
    </button>
    
    <button 
      class="nav-tab"
      [class.active]="currentView === 'preview'"
      (click)="setCurrentView('preview')"
      title="Schema Preview">
      <div class="nav-icon">ğŸ‘ï¸</div>
      <span class="nav-label">Preview</span>
    </button>
    
    <button 
      class="nav-tab"
      [class.active]="currentView === 'diagram'"
      (click)="setCurrentView('diagram')"
      title="Schema Diagram">
      <div class="nav-icon">ğŸ“Š</div>
      <span class="nav-label">Diagram</span>
    </button>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Full-Screen View -->
    <div class="full-view">
      <!-- View Header -->
      <div class="view-header">
        <h1 class="view-title">
          <span *ngIf="currentView === 'workspace'">Schema Workspace</span>
          <span *ngIf="currentView === 'preview'">Schema Preview</span>
          <span *ngIf="currentView === 'diagram'">Schema Diagram</span>
          <span class="draft-indicator" [title]="'Current JSON Schema Draft: ' + selectedDraft">
            {{ selectedDraft.replace('draft-', 'Draft ').replace('-', '/') }}
          </span>
        </h1>
        
        <div class="view-actions">
          <!-- Workspace Actions -->
          <ng-container *ngIf="currentView === 'workspace'">
            <button type="button" class="btn btn-sm btn-secondary" (click)="expandAll()" title="Expand All">
              ğŸ“‚ Expand
            </button>
            <button type="button" class="btn btn-sm btn-secondary" (click)="collapseAll()" title="Collapse All">
              ğŸ“ Collapse
            </button>
            <button type="button" class="btn btn-sm btn-outline" (click)="validateSchema()" title="Validate">
              âœ“ Validate
            </button>
            <button type="button" class="btn btn-sm btn-primary" (click)="addNewProperty()">
              + Add Property
            </button>
          </ng-container>

          <!-- Preview Actions -->
          <ng-container *ngIf="currentView === 'preview'">
            <button type="button" class="btn btn-sm btn-outline" (click)="copySchemaToClipboard()" title="Copy">
              ğŸ“‹ Copy
            </button>
            <button type="button" class="btn btn-sm btn-primary" (click)="exportSchema()" title="Export">
              ğŸ’¾ Export
            </button>
            <button type="button" class="btn btn-sm btn-success" (click)="publishToRegistry()" title="Publish to Schema Registry" [disabled]="!isRegistryConnected()">
              ğŸš€ Publish to Registry
            </button>
          </ng-container>

          <!-- Diagram Actions -->
          <ng-container *ngIf="currentView === 'diagram'">
            <button type="button" class="btn btn-sm btn-secondary" (click)="resetDiagramView()" title="Reset View">
              ğŸ¯ Reset
            </button>
            <button type="button" class="btn btn-sm btn-primary" (click)="exportDiagramSVG()" title="Export SVG">
              ğŸ–¼ï¸ Export SVG
            </button>
          </ng-container>

          <!-- Global Actions -->
          <button type="button" class="btn btn-sm btn-outline" (click)="toggleRightPanel()" title="Toggle Inspector">
            {{ showRightPanel ? 'ğŸ“Š' : 'ğŸ“ˆ' }}
          </button>
        </div>
      </div>

      <!-- View Content -->
      <div class="view-content">
        <!-- Workspace Content -->
        <div *ngIf="currentView === 'workspace'" class="workspace-content">
          <!-- Schema Configuration (inline when needed) -->
          <div class="workspace-config" [formGroup]="schemaForm">
            <div class="config-row">
              <div class="config-group">
                <label>Schema Title:</label>
                <input type="text" formControlName="title" placeholder="My Schema">
              </div>
              <div class="config-group">
                <label>Description:</label>
                <input type="text" formControlName="description" placeholder="Schema description">
              </div>
              <div class="config-group">
                <label>Schema {{ currentIdField }}:</label>
                <input type="text" formControlName="schemaId" [placeholder]="'Schema ' + currentIdField + ' (optional)'">
              </div>
              <div class="config-group">
                <label>
                  <input type="checkbox" formControlName="additionalProperties">
                  Allow Additional Properties
                </label>
              </div>
            </div>
          </div>

          <!-- Schema Registry Connection -->
          <app-registry-connection></app-registry-connection>

          <!-- Root-level Conditional Validation -->
          <div class="schema-level-dependencies" *ngIf="schema && getAllSchemaPropertyNames().length > 0">
            <div class="collapsible-header" (click)="toggleSchemaValidationSection()">
              <h4>
                <span class="collapse-icon">{{ schemaValidationExpanded ? 'â–¼' : 'â–¶' }}</span>
                Schema-Level Conditional Validation
              </h4>
            </div>
            
            <div class="collapsible-content" *ngIf="schemaValidationExpanded">
              <p class="help-text">Define validation rules that apply based on property values across the entire schema</p>
            
            <!-- Show dependency editor if conditional logic exists or if user chooses to add it -->
            <div *ngIf="hasRootLevelConditionalLogic() || showRootDependencyEditor">
              <app-dependency-editor
                [dependentSchemas]="extractRootDependentSchemas()"
                [availableProperties]="getAllSchemaPropertyNames()"
                [currentDraft]="selectedDraft"
                (dependentSchemasChange)="updateRootDependentSchemas($event)">
              </app-dependency-editor>
              
              <button 
                *ngIf="!hasRootLevelConditionalLogic() && showRootDependencyEditor"
                type="button" 
                class="btn btn-sm btn-outline" 
                (click)="hideRootDependencyEditor()"
                style="margin-top: 0.5rem;">
                âŒ Cancel Schema Validation
              </button>
            </div>
            
            <!-- Show add button if no conditional logic exists -->
            <div *ngIf="!hasRootLevelConditionalLogic() && !showRootDependencyEditor" class="schema-validation-prompt">
              <div class="validation-info">
                <h5>ğŸ’¡ Schema-Level Conditional Validation</h5>
                <p>Create rules like:</p>
                <ul class="examples-list">
                  <li>"If <strong>country</strong> is 'US', then <strong>postalCode</strong> must match US ZIP format"</li>
                  <li>"If <strong>type</strong> is 'premium', then <strong>features</strong> array is required"</li>
                  <li>"If <strong>age</strong> is under 18, then <strong>parentConsent</strong> is required"</li>
                </ul>
              </div>
              
              <button 
                type="button" 
                class="btn btn-sm btn-primary" 
                (click)="addSchemaLevelValidation()"
                title="Add conditional validation rules that apply to the entire schema">
                â• Add Schema-Level Validation
              </button>
              
              <p class="help-text" style="margin-top: 0.5rem; font-size: 0.85em; color: #888;">
                <span *ngIf="getAllSchemaPropertyNames().length === 0">
                  ğŸ’¡ We'll add some example properties to get you started.
                </span>
                <span *ngIf="getAllSchemaPropertyNames().length > 0">
                  Configure validation rules based on your existing properties.
                </span>
              </p>
            </div>
            </div>
          </div>

          <!-- Properties List -->
          <div class="properties-container" *ngIf="properties.length > 0; else workspaceEmpty">
            <div class="property-item" 
                 *ngFor="let property of properties; let i = index; trackBy: trackByPropertyId">
              
              <div class="property-controls">
                <button type="button" 
                        class="btn-icon" 
                        (click)="movePropertyUp(i)" 
                        [disabled]="i === 0"
                        title="Move up">
                  â†‘
                </button>
                <button type="button" 
                        class="btn-icon" 
                        (click)="movePropertyDown(i)" 
                        [disabled]="i === properties.length - 1"
                        title="Move down">
                  â†“
                </button>
                <button type="button" 
                        class="btn-icon" 
                        (click)="onPropertyDuplicated(property.id)"
                        title="Duplicate">
                  ğŸ“‹
                </button>
                <button type="button" 
                        class="btn-icon btn-danger" 
                        (click)="onPropertyDeleted(property.id)"
                        title="Delete">
                  ğŸ—‘ï¸
                </button>
              </div>

              <div class="property-content">
                <app-property-tree-editor
                  [property]="property"
                  [currentDraft]="selectedDraft"
                  [level]="0"
                  (propertyChange)="onPropertyUpdated($event)"
                  (deleteProperty)="onPropertyDeleted(property.id)">
                </app-property-tree-editor>
              </div>
            </div>
          </div>

          <!-- Empty Workspace State -->
          <ng-template #workspaceEmpty>
            <div class="workspace-empty">
              <div class="empty-icon">ğŸ“</div>
              <h2 class="empty-title">Start Building Your Schema</h2>
              <p class="empty-subtitle">Add properties to define your JSON schema structure</p>
              <button type="button" class="btn-primary-lg" (click)="addNewProperty()">
                + Add Your First Property
              </button>
            </div>
          </ng-template>
        </div>

        <!-- Preview Content -->
        <div *ngIf="currentView === 'preview'" class="preview-content">
          <app-schema-preview 
            [schema]="schema" 
            [enableInteractiveMode]="configForm.get('enableInteractivePreview')?.value"
            (schemaChange)="onSchemaUpdatedFromPreview($event)">
          </app-schema-preview>
        </div>

        <!-- Diagram Content -->
        <div *ngIf="currentView === 'diagram'" class="diagram-content">
          <app-cytoscape-diagram [schema]="schema"></app-cytoscape-diagram>
        </div>
      </div>
    </div>

    <!-- Right Inspector Panel -->
    <div class="right-panel" [class.hidden]="!showRightPanel">
      <div class="right-panel-header">
        <h3>Schema Inspector</h3>
        <button class="btn btn-sm" (click)="toggleRightPanel()" title="Close">Ã—</button>
      </div>
      
      <div class="panel-tabs">
        <button 
          class="panel-tab"
          [class.active]="activeRightTab === 'overview'"
          (click)="setActiveRightTab('overview')">Overview</button>
        <button 
          class="panel-tab"
          [class.active]="activeRightTab === 'settings'"
          (click)="setActiveRightTab('settings')">Settings</button>
      </div>
      
      <div class="right-panel-content">
        <!-- Overview Tab Content -->
        <ng-container *ngIf="activeRightTab === 'overview'">
          <!-- Schema Statistics -->
          <div class="inspector-section">
            <h3>Statistics</h3>
            <div class="schema-stats">
              <div class="stat-card">
                <span class="stat-number">{{ properties.length }}</span>
                <span class="stat-label">Properties</span>
              </div>
              <div class="stat-card">
                <span class="stat-number">{{ getRequiredPropertiesCount() }}</span>
                <span class="stat-label">Required</span>
              </div>
            </div>
            
            <div class="stat-card" style="margin-top: 1rem;">
              <span class="stat-number" [style.color]="getValidationStatusColor()">
                {{ getValidationStatusIcon() }}
              </span>
              <span class="stat-label">{{ getValidationStatusText() }}</span>
              <small *ngIf="validationResult && !validationResult.isValid" class="validation-hint">
                {{ validationResult.summary.totalErrors }} error(s), {{ validationResult.summary.totalWarnings }} warning(s)
              </small>
            </div>
          </div>

          <!-- Property Types -->
          <div class="inspector-section">
            <h3>Property Types</h3>
            <div class="type-summary" *ngFor="let entry of getPropertyTypeSummaryEntries()">
              <div class="type-badge" [class]="'type-' + entry.type.toLowerCase()">
                {{ entry.type }}
              </div>
              <span class="type-count">{{ entry.count }}</span>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="inspector-section">
            <h3>Quick Actions</h3>
            <div class="action-buttons">
              <button class="btn btn-sm btn-outline" (click)="loadTemplate('basic')" style="width: 100%; margin-bottom: 0.5rem;">
                ğŸ“‹ Load Template
              </button>
              <button class="btn btn-sm btn-outline" (click)="resetSchema()" style="width: 100%; margin-bottom: 0.5rem;">
                ğŸ”„ Reset Schema
              </button>
              <input type="file" accept=".json" style="display: none" #fileInput (change)="importSchema($event)">
              <button class="btn btn-sm btn-primary" (click)="fileInput.click()" style="width: 100%;">
                ğŸ“ Import Schema
              </button>
            </div>
          </div>
        </ng-container>

        <!-- Settings Tab Content -->
        <ng-container *ngIf="activeRightTab === 'settings'">
          <div class="inspector-section" [formGroup]="configForm">
            <h3>Schema Generation</h3>
            
            <div class="setting-item">
              <label class="setting-label">
                <input 
                  type="checkbox" 
                  formControlName="useReferences" 
                  class="setting-checkbox">
                <span class="setting-text">
                  <strong>Use $ref Patterns</strong>
                  <small>Generate $ref references for reusable object definitions</small>
                </span>
              </label>
            </div>

            <div class="setting-item">
              <label class="setting-label">
                <input 
                  type="checkbox" 
                  formControlName="generateDefinitions" 
                  class="setting-checkbox">
                <span class="setting-text">
                  <strong>Generate Definitions</strong>
                  <small>Create reusable definitions section in schema</small>
                </span>
              </label>
            </div>

            <div class="setting-item">
              <label class="setting-label">
                <span class="setting-text">
                  <strong>JSON Schema Draft Version</strong>
                  <small>Controls validation and feature support in the editor</small>
                </span>
              </label>
              <select formControlName="draftVersion" class="form-control form-control-sm" style="margin-top: 0.25rem;">
                <option *ngFor="let draft of availableDrafts" [value]="draft.value">
                  {{ draft.label }}
                </option>
              </select>
            </div>
            
            <div class="setting-item">
              <label class="setting-label">
                <input 
                  type="checkbox" 
                  formControlName="enableInteractivePreview" 
                  class="setting-checkbox">
                <span class="setting-text">
                  <strong>Interactive Preview (Monaco Editor)</strong>
                  <small>Enable Monaco editor for power users to edit schema directly</small>
                </span>
              </label>
            </div>
          </div>

          <div class="inspector-section" [formGroup]="schemaForm">
            <h3>Schema Info</h3>
            
            <div class="setting-item">
              <label class="setting-label-field">
                <span class="setting-field-text">Schema Title</span>
                <input 
                  type="text" 
                  class="setting-input" 
                  formControlName="title"
                  placeholder="Enter schema title...">
              </label>
            </div>

            <div class="setting-item">
              <label class="setting-label-field">
                <span class="setting-field-text">Description</span>
                <textarea 
                  class="setting-textarea" 
                  formControlName="description"
                  placeholder="Enter schema description..."
                  rows="3"></textarea>
              </label>
            </div>
          </div>

          <div class="inspector-section">
            <h3>Schema Validation</h3>
            
            <div class="setting-item">
              <label class="setting-label-field">
                <span class="setting-field-text">JSON Schema Draft</span>
                <select 
                  class="setting-input" 
                  [(ngModel)]="selectedDraft"
                  (change)="onDraftChange(selectedDraft)">
                  <option *ngFor="let draft of getSupportedDrafts()" [value]="draft">
                    {{ draft }}
                  </option>
                </select>
              </label>
            </div>

            <div class="setting-item">
              <button 
                type="button" 
                class="btn btn-sm btn-primary validation-btn" 
                (click)="validateSchema()">
                ğŸ” Validate Schema
              </button>
            </div>

            <!-- Validation Results -->
            <div class="validation-results" *ngIf="validationResult">
              <div class="validation-summary" [class.valid]="validationResult.isValid" [class.invalid]="!validationResult.isValid">
                <div class="validation-status">
                  <span class="status-icon">{{ validationResult.isValid ? 'âœ…' : 'âš ï¸' }}</span>
                  <span class="status-text">
                    {{ validationResult.isValid ? 'Valid Schema' : validationResult.summary.totalErrors + ' Error(s)' }}
                  </span>
                </div>
                
                <div class="validation-stats">
                  <small>
                    {{ validationResult.summary.propertiesValidated }} properties â€¢ 
                    {{ validationResult.summary.totalWarnings }} warning(s) â€¢ 
                    {{ validationResult.draft }}
                  </small>
                </div>
              </div>

              <button 
                type="button" 
                class="btn btn-sm btn-outline details-toggle" 
                (click)="toggleValidationDetails()">
                {{ showValidationDetails ? 'ğŸ”¼ Hide Details' : 'ğŸ”½ Show Details' }}
              </button>

              <!-- Detailed Results -->
              <div class="validation-details" *ngIf="showValidationDetails">
                <!-- Errors -->
                <div class="validation-section" *ngIf="validationResult.errors.length > 0">
                  <h4>ğŸš¨ Errors</h4>
                  <div class="validation-item error" *ngFor="let error of validationResult.errors">
                    <div class="validation-path">{{ error.path }}</div>
                    <div class="validation-message">{{ error.message }}</div>
                    <div class="validation-suggestion" *ngIf="error.suggestion">
                      ğŸ’¡ {{ error.suggestion }}
                    </div>
                  </div>
                </div>

                <!-- Warnings -->
                <div class="validation-section" *ngIf="validationResult.warnings.length > 0">
                  <h4>âš ï¸ Warnings</h4>
                  <div class="validation-item warning" *ngFor="let warning of validationResult.warnings">
                    <div class="validation-path">{{ warning.path }}</div>
                    <div class="validation-message">{{ warning.message }}</div>
                    <div class="validation-suggestion" *ngIf="warning.suggestion">
                      ğŸ’¡ {{ warning.suggestion }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</div>