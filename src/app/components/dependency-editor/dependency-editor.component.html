<div class="dependency-editor">
  <div class="dependency-header">
    <h4>Dependent Schemas</h4>
    <p class="header-description">Define conditional schema rules based on property values</p>
  </div>

  <!-- Existing Dependency Rules -->
  <div class="dependency-rules" *ngIf="dependencyRules.length > 0">
    <div 
      *ngFor="let rule of dependencyRules" 
      class="dependency-rule"
      [class.editing]="editingRuleId === rule.id">
      
      <div class="rule-header">
        <div class="rule-summary">
          <strong>{{ getRuleDescription(rule) }}</strong>
          <span class="rule-description" *ngIf="rule.description">- {{ rule.description }}</span>
        </div>
        
        <div class="rule-actions">
          <button 
            type="button" 
            class="btn-edit"
            (click)="startEditingRule(rule.id)"
            *ngIf="editingRuleId !== rule.id"
            title="Edit rule">
            ‚úèÔ∏è
          </button>
          <button 
            type="button" 
            class="btn-done"
            (click)="stopEditingRule()"
            *ngIf="editingRuleId === rule.id"
            title="Done editing">
            ‚úì
          </button>
          <button 
            type="button" 
            class="btn-remove"
            (click)="removeDependencyRule(rule.id)"
            title="Remove rule">
            üóëÔ∏è
          </button>
        </div>
      </div>

      <!-- Rule Configuration (when editing) -->
      <div class="rule-config" *ngIf="editingRuleId === rule.id">
        <div class="config-row">
          <div class="config-field">
            <label>Trigger Property:</label>
            <select 
              [value]="rule.triggerProperty"
              (change)="updateRuleTriggerProperty(rule.id, $any($event.target).value)">
              <option value="">Select property...</option>
              <option *ngFor="let prop of availableProperties" [value]="prop">{{ prop }}</option>
            </select>
          </div>

          <div class="config-field">
            <label>Condition:</label>
            <select 
              [value]="rule.triggerCondition"
              (change)="updateRuleTriggerCondition(rule.id, $any($event.target).value)">
              <option *ngFor="let condition of triggerConditions" [value]="condition.value">
                {{ condition.label }}
              </option>
            </select>
          </div>

          <div class="config-field" *ngIf="getTriggerCondition(rule.triggerCondition).needsValue">
            <label>Value:</label>
            <input 
              type="text" 
              [value]="rule.triggerValue || ''"
              (input)="updateRuleTriggerValue(rule.id, $any($event.target).value)"
              placeholder="Enter value or comma-separated values">
          </div>
        </div>

        <div class="config-row">
          <div class="config-field full-width">
            <label>Description (optional):</label>
            <input 
              type="text" 
              [value]="rule.description || ''"
              (input)="updateRuleDescription(rule.id, $any($event.target).value)"
              placeholder="Describe when this rule applies">
          </div>
        </div>

        <!-- Conditional Schema Editor -->
        <div class="conditional-schema">
          <h5>What should happen when the condition is met:</h5>
          
          <!-- Required Properties Section -->
          <div class="then-section">
            <h6>Required Properties</h6>
            <p class="help-text">Select properties that become required when the condition is met:</p>
            
            <div class="required-properties">
              <div class="property-checkboxes" *ngIf="availableProperties.length > 0">
                <label *ngFor="let prop of availableProperties" class="property-checkbox">
                  <input 
                    type="checkbox" 
                    [checked]="rule.requiredProperties.includes(prop)"
                    (change)="toggleRequiredProperty(rule.id, prop, $any($event.target).checked)">
                  <span>{{ prop }}</span>
                </label>
              </div>
              
              <div *ngIf="availableProperties.length === 0" class="no-properties">
                <p>No properties available. Add properties to the schema first.</p>
              </div>
            </div>
          </div>
          
          <!-- Additional Schema Constraints -->
          <div class="then-section">
            <h6>Additional Schema Constraints (Optional)</h6>
            <div class="basic-schema-editor">
              <div class="field-group">
                <label>Schema Type:</label>
                <select [(ngModel)]="rule.conditionalSchema.type" (change)="onConditionalSchemaChange(rule.id, rule.conditionalSchema)">
                  <option [value]="PropertyType.OBJECT">Object (default)</option>
                  <option [value]="PropertyType.STRING">String</option>
                  <option [value]="PropertyType.NUMBER">Number</option>
                  <option [value]="PropertyType.INTEGER">Integer</option>
                  <option [value]="PropertyType.BOOLEAN">Boolean</option>
                  <option [value]="PropertyType.ARRAY">Array</option>
                </select>
              </div>
              
              <div class="field-group">
                <label>Description:</label>
                <input 
                  type="text" 
                  [(ngModel)]="rule.conditionalSchema.description"
                  (input)="onConditionalSchemaChange(rule.id, rule.conditionalSchema)"
                  placeholder="Describe additional constraints (optional)">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add New Rule Form -->
  <div class="add-rule-section">
    <button 
      type="button" 
      class="btn-add-rule"
      (click)="toggleAddRule()"
      *ngIf="!showAddRule">
      + Add Dependency Rule
    </button>

    <div class="add-rule-form" *ngIf="showAddRule">
      <h5>Create New Dependency Rule</h5>
      
      <div class="form-row">
        <div class="form-field">
          <label>Trigger Property:</label>
          <select [(ngModel)]="newRuleTriggerProperty">
            <option value="">Select property...</option>
            <option *ngFor="let prop of availableProperties" [value]="prop">{{ prop }}</option>
          </select>
        </div>

        <div class="form-field">
          <label>Condition:</label>
          <select [(ngModel)]="newRuleTriggerCondition">
            <option *ngFor="let condition of triggerConditions" [value]="condition.value">
              {{ condition.label }}
            </option>
          </select>
        </div>

        <div class="form-field" *ngIf="getTriggerCondition(newRuleTriggerCondition).needsValue">
          <label>Value:</label>
          <input 
            type="text" 
            [(ngModel)]="newRuleTriggerValue"
            placeholder="Enter value">
        </div>
      </div>

      <div class="form-actions">
        <button 
          type="button" 
          class="btn btn-primary"
          (click)="addDependencyRule()"
          [disabled]="!newRuleTriggerProperty.trim()">
          Create Rule
        </button>
        <button 
          type="button" 
          class="btn btn-secondary"
          (click)="toggleAddRule()">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="dependencyRules.length === 0 && !showAddRule">
    <p>No dependency rules defined.</p>
    <p class="help-text">Dependency rules allow you to require certain properties or apply specific schemas based on the values of other properties.</p>
    <button type="button" class="btn btn-primary" (click)="toggleAddRule()">
      Add First Rule
    </button>
  </div>
</div>