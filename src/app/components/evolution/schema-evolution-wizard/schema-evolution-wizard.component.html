<div class="evolution-wizard">
      <div class="wizard-header">
        <div class="breadcrumb">
          <button class="back-btn" (click)="goBack()">← Back</button>
          <span class="separator">/</span>
          <span class="current-page">Schema Evolution Wizard</span>
        </div>
        
        <div class="wizard-title">
          <h1>Evolve Schema: {{ context.subjectName }}</h1>
          <div class="base-version" *ngIf="context.baseVersion">
            From version {{ context.baseVersion.version }}
          </div>
        </div>
      </div>

      <!-- Wizard Progress -->
      <div class="wizard-progress">
        <div 
          *ngFor="let step of steps; let i = index"
          class="progress-step"
          [class.active]="currentStep === i"
          [class.completed]="step.completed"
          [class.invalid]="!step.valid && currentStep > i"
        >
          <div class="step-number">
            <span *ngIf="step.completed">✓</span>
            <span *ngIf="!step.completed">{{ i + 1 }}</span>
          </div>
          <div class="step-info">
            <div class="step-title">{{ step.title }}</div>
            <div class="step-description">{{ step.description }}</div>
          </div>
        </div>
      </div>

      <!-- Wizard Content -->
      <div class="wizard-content" *ngIf="!loading && !error">
        
        <!-- Step 1: Select Base Schema -->
        <div class="wizard-step" *ngIf="currentStep === 0">
          <h2>Step 1: Select Base Schema</h2>
          <p>Choose the schema version you want to evolve from.</p>
          
          <div class="base-selection">
            <div class="current-base" *ngIf="context.baseVersion">
              <h3>Selected Base Version</h3>
              <div class="version-card">
                <div class="version-info">
                  <span class="version-number">v{{ context.baseVersion.version }}</span>
                  <span class="version-id">ID: {{ context.baseVersion.id }}</span>
                  <span class="schema-type">{{ context.baseVersion.schemaType }}</span>
                </div>
                <button class="change-btn" (click)="showVersionSelector = true">Change</button>
              </div>
              
              <div class="schema-preview">
                <h4>Current Schema</h4>
                <pre class="schema-code">{{ formatSchema(context.baseVersion.schema) }}</pre>
              </div>
            </div>
            
            <div class="version-selector" *ngIf="showVersionSelector">
              <h3>Available Versions</h3>
              <div class="versions-list">
                <div 
                  *ngFor="let version of availableVersions"
                  class="version-option"
                  [class.selected]="version.version === context.baseVersion.version"
                  (click)="selectBaseVersion(version)"
                >
                  <div class="version-header">
                    <span class="version-number">v{{ version.version }}</span>
                    <span class="version-date" *ngIf="version.createdAt">
                      {{ version.createdAt | date:'short' }}
                    </span>
                  </div>
                  <div class="version-id">ID: {{ version.id }}</div>
                </div>
              </div>
              <button class="cancel-btn" (click)="showVersionSelector = false">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Step 2: Edit Schema -->
        <div class="wizard-step" *ngIf="currentStep === 1">
          <h2>Step 2: Edit Schema</h2>
          <p>Make your changes to the schema. The system will analyze compatibility as you edit.</p>
          
          <div class="schema-editor">
            <div class="editor-controls">
              <button class="control-btn" (click)="loadSchemaInEditor()">
                Load in Visual Editor
              </button>
              <button class="control-btn" (click)="importFromFile()">
                Import from File
              </button>
              <button class="control-btn" (click)="resetToBase()">
                Reset to Base
              </button>
            </div>
            
            <div class="editor-content">
              <div class="json-editor">
                <h4>Edit Schema JSON</h4>
                <textarea 
                  class="schema-textarea"
                  [(ngModel)]="schemaJson"
                  (ngModelChange)="onSchemaChange()"
                  placeholder="Enter your JSON schema here..."
                ></textarea>
                <div class="json-validation" *ngIf="jsonError" class="error">
                  Invalid JSON: {{ jsonError }}
                </div>
              </div>
              
              <div class="preview-panel">
                <h4>Schema Preview</h4>
                <pre class="schema-preview">{{ formatSchema(schemaJson) }}</pre>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Compatibility Analysis -->
        <div class="wizard-step" *ngIf="currentStep === 2">
          <h2>Step 3: Compatibility Analysis</h2>
          <p>Review the changes and compatibility analysis before publishing.</p>
          
          <div class="analysis-results" *ngIf="context.evolutionAnalysis">
            <div class="compatibility-overview">
              <div class="compatibility-status">
                <div 
                  class="status-indicator"
                  [class.compatible]="context.evolutionAnalysis.isBackwardCompatible"
                  [class.incompatible]="!context.evolutionAnalysis.isBackwardCompatible"
                >
                  <span class="status-icon">
                    {{ context.evolutionAnalysis.isBackwardCompatible ? '✓' : '⚠️' }}
                  </span>
                  <span class="status-text">
                    {{ context.evolutionAnalysis.isBackwardCompatible ? 'Backward Compatible' : 'Breaking Changes Detected' }}
                  </span>
                </div>
                
                <div class="changes-summary">
                  <span class="change-count breaking" *ngIf="getBreakingChangesCount() > 0">
                    {{ getBreakingChangesCount() }} Breaking
                  </span>
                  <span class="change-count non-breaking">
                    {{ getNonBreakingChangesCount() }} Non-Breaking
                  </span>
                  <span class="change-count total">
                    {{ context.evolutionAnalysis.changes.length }} Total Changes
                  </span>
                </div>
              </div>
            </div>

            <div class="changes-details">
              <h3>Detected Changes</h3>
              <div class="changes-list">
                <div 
                  *ngFor="let change of context.evolutionAnalysis.changes"
                  class="change-item"
                  [class.breaking]="change.breaking"
                >
                  <div class="change-header">
                    <span class="change-type">{{ change.type }}</span>
                    <span class="change-impact" [attr.data-impact]="change.impact">
                      {{ change.impact }}
                    </span>
                    <span class="breaking-indicator" *ngIf="change.breaking">Breaking</span>
                  </div>
                  <div class="change-description">{{ change.description }}</div>
                  <div class="change-field" *ngIf="change.field">
                    Field: <code>{{ change.field }}</code>
                  </div>
                </div>
              </div>
            </div>

            <div class="migration-guidance" *ngIf="context.evolutionAnalysis.migrationPath.length > 0">
              <h3>Migration Guidance</h3>
              <div class="migration-steps">
                <div 
                  *ngFor="let step of context.evolutionAnalysis.migrationPath"
                  class="migration-step"
                >
                  <div class="step-action">{{ step.action }}</div>
                  <div class="step-description">{{ step.description }}</div>
                  <pre class="step-code" *ngIf="step.code">{{ step.code }}</pre>
                </div>
              </div>
            </div>

            <div class="risk-assessment" *ngIf="context.evolutionAnalysis.riskAssessment">
              <h3>Risk Assessment</h3>
              <div 
                class="risk-level"
                [attr.data-risk]="context.evolutionAnalysis.riskAssessment.overallRisk"
              >
                <span class="risk-indicator">{{ getRiskIcon(context.evolutionAnalysis.riskAssessment.overallRisk) }}</span>
                <span class="risk-text">{{ context.evolutionAnalysis.riskAssessment.overallRisk }} Risk</span>
              </div>
              <div class="risk-factors">
                <div *ngFor="let action of context.evolutionAnalysis.riskAssessment.recommendedActions" class="risk-factor">
                  {{ action }}
                </div>
              </div>
            </div>
          </div>

          <div class="no-analysis" *ngIf="!context.evolutionAnalysis">
            <p>No changes detected or analysis not available.</p>
          </div>
        </div>

        <!-- Step 4: Publish Configuration -->
        <div class="wizard-step" *ngIf="currentStep === 3">
          <h2>Step 4: Publish Configuration</h2>
          <p>Configure the publishing options for your new schema version.</p>
          
          <div class="publish-config">
            <div class="config-section">
              <h3>Version Information</h3>
              <div class="form-group">
                <label for="subject">Subject Name:</label>
                <input 
                  type="text" 
                  id="subject"
                  [(ngModel)]="context.publishConfig.subject"
                  readonly
                  class="readonly-input"
                >
              </div>
              
              <div class="form-group">
                <label for="version-type">Version Type:</label>
                <select id="version-type" [(ngModel)]="versionType" (change)="updateVersionNumber()">
                  <option value="patch">Patch (Non-breaking)</option>
                  <option value="minor">Minor (Backward compatible)</option>
                  <option value="major">Major (Breaking changes)</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="next-version">Next Version:</label>
                <input 
                  type="number" 
                  id="next-version"
                  [(ngModel)]="nextVersion"
                  readonly
                  class="readonly-input"
                >
              </div>
            </div>

            <div class="config-section">
              <h3>Compatibility Settings</h3>
              <div class="form-group">
                <label for="compatibility">Compatibility Level:</label>
                <select id="compatibility" [(ngModel)]="context.compatibilityLevel">
                  <option value="BACKWARD">Backward Compatible</option>
                  <option value="FORWARD">Forward Compatible</option>
                  <option value="FULL">Full Compatible</option>
                  <option value="NONE">No Compatibility</option>
                </select>
              </div>
              
              <div class="compatibility-warning" *ngIf="hasCompatibilityWarning()">
                <span class="warning-icon">⚠️</span>
                {{ getCompatibilityWarning() }}
              </div>
            </div>

            <div class="config-section">
              <h3>Additional Options</h3>
              <div class="checkbox-group">
                <label>
                  <input type="checkbox" [(ngModel)]="validateCompatibility">
                  Validate compatibility before publishing
                </label>
              </div>
              <div class="checkbox-group">
                <label>
                  <input type="checkbox" [(ngModel)]="createBackup">
                  Create backup of previous version
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 5: Review and Publish -->
        <div class="wizard-step" *ngIf="currentStep === 4">
          <h2>Step 5: Review and Publish</h2>
          <p>Review all settings and publish your new schema version.</p>
          
          <div class="publish-review">
            <div class="review-section">
              <h3>Evolution Summary</h3>
              <div class="summary-grid">
                <div class="summary-item">
                  <span class="label">Subject:</span>
                  <span class="value">{{ context.subjectName }}</span>
                </div>
                <div class="summary-item">
                  <span class="label">Base Version:</span>
                  <span class="value">v{{ context.baseVersion.version }}</span>
                </div>
                <div class="summary-item">
                  <span class="label">New Version:</span>
                  <span class="value">v{{ nextVersion }}</span>
                </div>
                <div class="summary-item">
                  <span class="label">Compatibility:</span>
                  <span class="value">{{ context.compatibilityLevel }}</span>
                </div>
                <div class="summary-item">
                  <span class="label">Changes:</span>
                  <span class="value">{{ (context.evolutionAnalysis?.changes || []).length }}</span>
                </div>
                <div class="summary-item">
                  <span class="label">Breaking:</span>
                  <span class="value">{{ getBreakingChangesCount() }}</span>
                </div>
              </div>
            </div>

            <div class="review-section">
              <h3>Final Schema</h3>
              <pre class="final-schema">{{ formatSchema(schemaJson) }}</pre>
            </div>

            <div class="publish-actions">
              <button 
                class="publish-btn primary"
                (click)="publishSchema()"
                [disabled]="publishing"
              >
                {{ publishing ? 'Publishing...' : 'Publish Schema' }}
              </button>
              <button class="publish-btn secondary" (click)="saveDraft()">
                Save as Draft
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Wizard Navigation -->
      <div class="wizard-navigation" *ngIf="!loading && !error">
        <button 
          class="nav-btn secondary"
          (click)="previousStep()"
          [disabled]="currentStep === 0"
        >
          Previous
        </button>
        
        <div class="step-indicator">
          Step {{ currentStep + 1 }} of {{ steps.length }}
        </div>
        
        <button 
          class="nav-btn primary"
          (click)="nextStep()"
          [disabled]="!canProceed()"
        >
          {{ currentStep === steps.length - 1 ? 'Review' : 'Next' }}
        </button>
      </div>

      <!-- Loading State -->
      <div class="loading-state" *ngIf="loading">
        <div class="spinner"></div>
        <p>Loading evolution wizard...</p>
      </div>

      <!-- Error State -->
      <div class="error-state" *ngIf="error">
        <div class="error-icon">⚠️</div>
        <h3>Error</h3>
        <p>{{ error }}</p>
        <button class="retry-btn" (click)="initialize()">Retry</button>
      </div>

      <!-- Success Modal -->
      <div class="success-modal" *ngIf="publishSuccess" (click)="closeSuccessModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <div class="success-header">
            <span class="success-icon">✅</span>
            <h3>Schema Published Successfully!</h3>
          </div>
          <div class="success-details">
            <p>Your schema has been successfully registered with ID: <strong>{{ publishResult?.schemaId }}</strong></p>
            <p>Version: <strong>{{ nextVersion }}</strong></p>
          </div>
          <div class="success-actions">
            <button class="action-btn primary" (click)="viewPublishedSchema()">
              View Schema
            </button>
            <button class="action-btn secondary" (click)="closeSuccessModal()">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>