<div class="version-compare">
      <div class="compare-header">
        <div class="breadcrumb">
          <button class="back-btn" (click)="goBack()">← Back to Subject</button>
          <span class="separator">/</span>
          <span class="current-page">Version Comparison</span>
        </div>
        
        <div class="subject-info" *ngIf="context.subjectName">
          <h1>{{ context.subjectName }}</h1>
          <div class="comparison-info" *ngIf="context.fromVersion && context.toVersion">
            Comparing v{{ context.fromVersion.version }} → v{{ context.toVersion.version }}
          </div>
        </div>
      </div>

      <div class="version-selector" *ngIf="!loading && !error">
        <div class="selector-section">
          <div class="version-select-group">
            <label>From Version:</label>
            <select [(ngModel)]="selectedFromVersion" (change)="onVersionSelectionChange()">
              <option value="">Select version</option>
              <option *ngFor="let version of availableVersions" [value]="version.version">
                v{{ version.version }} (ID: {{ version.id }})
              </option>
            </select>
          </div>
          
          <div class="comparison-arrow">→</div>
          
          <div class="version-select-group">
            <label>To Version:</label>
            <select [(ngModel)]="selectedToVersion" (change)="onVersionSelectionChange()">
              <option value="">Select version</option>
              <option *ngFor="let version of availableVersions" [value]="version.version">
                v{{ version.version }} (ID: {{ version.id }})
              </option>
            </select>
          </div>
          
          <button 
            class="swap-btn"
            (click)="swapVersions()"
            [disabled]="!selectedFromVersion || !selectedToVersion"
            title="Swap versions"
          >
            ⟷
          </button>
        </div>

        <div class="view-controls">
          <div class="view-modes">
            <button 
              class="mode-btn"
              [class.active]="viewMode === 'side-by-side'"
              (click)="viewMode = 'side-by-side'"
            >
              Side by Side
            </button>
            <button 
              class="mode-btn"
              [class.active]="viewMode === 'unified'"
              (click)="viewMode = 'unified'"
            >
              Unified Diff
            </button>
            <button 
              class="mode-btn"
              [class.active]="viewMode === 'json-diff'"
              (click)="viewMode = 'json-diff'"
            >
              JSON Diff
            </button>
          </div>

          <div class="diff-options">
            <label>
              <input type="checkbox" [(ngModel)]="showOnlyChanges">
              Show only changes
            </label>
            <label>
              <input type="checkbox" [(ngModel)]="highlightBreaking">
              Highlight breaking changes
            </label>
            <label>
              <input type="checkbox" [(ngModel)]="showLineNumbers">
              Show line numbers
            </label>
          </div>
        </div>
      </div>

      <!-- Comparison Results -->
      <div class="comparison-content" *ngIf="context.evolutionAnalysis && !loading && !error">
        
        <!-- Analysis Summary -->
        <div class="analysis-summary">
          <div class="summary-header">
            <h3>Change Analysis</h3>
            <div class="export-controls">
              <button class="export-btn" (click)="exportComparison()">Export Report</button>
              <button class="export-btn" (click)="shareComparison()">Share Link</button>
            </div>
          </div>
          
          <div class="summary-stats">
            <div class="stat-card">
              <div class="stat-number">{{ context.evolutionAnalysis.changes.length }}</div>
              <div class="stat-label">Total Changes</div>
            </div>
            <div class="stat-card breaking" *ngIf="getBreakingChangesCount() > 0">
              <div class="stat-number">{{ getBreakingChangesCount() }}</div>
              <div class="stat-label">Breaking Changes</div>
            </div>
            <div class="stat-card non-breaking">
              <div class="stat-number">{{ getNonBreakingChangesCount() }}</div>
              <div class="stat-label">Non-Breaking</div>
            </div>
            <div class="stat-card compatibility" [class.compatible]="context.evolutionAnalysis.isBackwardCompatible">
              <div class="stat-indicator">
                {{ context.evolutionAnalysis.isBackwardCompatible ? '✓' : '⚠️' }}
              </div>
              <div class="stat-label">
                {{ context.evolutionAnalysis.isBackwardCompatible ? 'Compatible' : 'Incompatible' }}
              </div>
            </div>
          </div>

          <div class="changes-filter" *ngIf="context.evolutionAnalysis.changes.length > 0">
            <div class="filter-controls">
              <select [(ngModel)]="changeTypeFilter" (change)="applyFilters()">
                <option value="">All Change Types</option>
                <option value="FIELD_ADDED">Field Added</option>
                <option value="FIELD_REMOVED">Field Removed</option>
                <option value="FIELD_TYPE_CHANGED">Type Changed</option>
                <option value="CONSTRAINT_ADDED">Constraint Added</option>
                <option value="CONSTRAINT_REMOVED">Constraint Removed</option>
                <option value="REQUIRED_ADDED">Required Added</option>
                <option value="REQUIRED_REMOVED">Required Removed</option>
              </select>
              
              <select [(ngModel)]="impactFilter" (change)="applyFilters()">
                <option value="">All Impact Levels</option>
                <option value="LOW">Low Impact</option>
                <option value="MEDIUM">Medium Impact</option>
                <option value="HIGH">High Impact</option>
                <option value="CRITICAL">Critical Impact</option>
              </select>
              
              <button class="clear-filters-btn" (click)="clearFilters()" *ngIf="hasActiveFilters()">
                Clear Filters
              </button>
            </div>
          </div>
        </div>

        <!-- Side by Side View -->
        <div class="side-by-side-view" *ngIf="viewMode === 'side-by-side'">
          <div class="schema-comparison">
            <div class="schema-panel">
              <div class="panel-header">
                <h4>Version {{ context.fromVersion?.version }}</h4>
                <div class="panel-meta">
                  <span class="version-id">ID: {{ context.fromVersion?.id }}</span>
                  <span class="version-date" *ngIf="context.fromVersion?.createdAt">
                    {{ context.fromVersion?.createdAt | date:'short' }}
                  </span>
                </div>
              </div>
              <div class="schema-content">
                <pre 
                  class="schema-code"
                  [innerHTML]="getHighlightedSchema('from')"
                ></pre>
              </div>
            </div>

            <div class="changes-panel">
              <div class="panel-header">
                <h4>Changes ({{ filteredChanges.length }})</h4>
              </div>
              <div class="changes-list">
                <div 
                  *ngFor="let change of filteredChanges; trackBy: trackByChange"
                  class="change-item"
                  [class.breaking]="change.breaking"
                  [class.selected]="selectedChange === change"
                  (click)="selectChange(change)"
                >
                  <div class="change-header">
                    <span class="change-type">{{ change.type }}</span>
                    <span class="change-impact" [attr.data-impact]="change.impact">
                      {{ change.impact }}
                    </span>
                    <span class="breaking-badge" *ngIf="change.breaking">Breaking</span>
                  </div>
                  <div class="change-description">{{ change.description }}</div>
                  <div class="change-path" *ngIf="change.field">
                    <code>{{ change.field }}</code>
                  </div>
                  <div class="change-details" *ngIf="change.oldValue || change.newValue">
                    <div class="old-value" *ngIf="change.oldValue">
                      <span class="label">Before:</span>
                      <code>{{ formatValue(change.oldValue) }}</code>
                    </div>
                    <div class="new-value" *ngIf="change.newValue">
                      <span class="label">After:</span>
                      <code>{{ formatValue(change.newValue) }}</code>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="schema-panel">
              <div class="panel-header">
                <h4>Version {{ context.toVersion?.version }}</h4>
                <div class="panel-meta">
                  <span class="version-id">ID: {{ context.toVersion?.id }}</span>
                  <span class="version-date" *ngIf="context.toVersion?.createdAt">
                    {{ context.toVersion?.createdAt | date:'short' }}
                  </span>
                </div>
              </div>
              <div class="schema-content">
                <pre 
                  class="schema-code"
                  [innerHTML]="getHighlightedSchema('to')"
                ></pre>
              </div>
            </div>
          </div>
        </div>

        <!-- Unified Diff View -->
        <div class="unified-view" *ngIf="viewMode === 'unified'">
          <div class="diff-header">
            <h4>Unified Diff</h4>
            <div class="diff-legend">
              <span class="legend-item added">+ Added</span>
              <span class="legend-item removed">- Removed</span>
              <span class="legend-item modified">~ Modified</span>
            </div>
          </div>
          <div class="unified-diff">
            <pre class="diff-content" [innerHTML]="getUnifiedDiff()"></pre>
          </div>
        </div>

        <!-- JSON Diff View -->
        <div class="json-diff-view" *ngIf="viewMode === 'json-diff'">
          <div class="diff-header">
            <h4>Structured JSON Diff</h4>
            <div class="json-controls">
              <button class="control-btn" (click)="expandAll()">Expand All</button>
              <button class="control-btn" (click)="collapseAll()">Collapse All</button>
            </div>
          </div>
          <div class="json-diff-tree">
            <div 
              *ngFor="let diff of schemaDiffs"
              class="diff-node"
              [class.breaking]="diff.breaking"
            >
              <div class="node-header">
                <span class="node-path">{{ diff.path }}</span>
                <span class="node-type" [attr.data-type]="diff.type">{{ diff.type }}</span>
              </div>
              <div class="node-description">{{ diff.description }}</div>
              <div class="node-values" *ngIf="diff.oldValue !== undefined || diff.newValue !== undefined">
                <div class="old-value" *ngIf="diff.oldValue !== undefined">
                  <span class="value-label">Old:</span>
                  <code>{{ formatValue(diff.oldValue) }}</code>
                </div>
                <div class="new-value" *ngIf="diff.newValue !== undefined">
                  <span class="value-label">New:</span>
                  <code>{{ formatValue(diff.newValue) }}</code>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Migration Guidance -->
        <div class="migration-section" *ngIf="context.evolutionAnalysis.migrationPath.length > 0">
          <h3>Migration Guidance</h3>
          <div class="migration-steps">
            <div 
              *ngFor="let step of context.evolutionAnalysis.migrationPath; let i = index"
              class="migration-step"
            >
              <div class="step-header">
                <span class="step-number">{{ i + 1 }}</span>
                <span class="step-action">{{ step.action }}</span>
              </div>
              <div class="step-description">{{ step.description }}</div>
              <pre class="step-code" *ngIf="step.code">{{ step.code }}</pre>
            </div>
          </div>
        </div>
      </div>

      <!-- No Comparison State -->
      <div class="no-comparison" *ngIf="!context.evolutionAnalysis && !loading && !error">
        <div class="no-comparison-content">
          <div class="no-comparison-icon">🔍</div>
          <h3>Select Versions to Compare</h3>
          <p>Choose two different versions to see a detailed comparison and evolution analysis.</p>
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading-state" *ngIf="loading">
        <div class="spinner"></div>
        <p>Loading version comparison...</p>
      </div>

      <!-- Error State -->
      <div class="error-state" *ngIf="error">
        <div class="error-icon">⚠️</div>
        <h3>Error Loading Comparison</h3>
        <p>{{ error }}</p>
        <button class="retry-btn" (click)="loadVersions()">Retry</button>
      </div>
    </div>